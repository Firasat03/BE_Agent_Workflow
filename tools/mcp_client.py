"""
tools/mcp_client.py — MCP Client factory

Returns a configured MCP client for a given agent based on the
mcp/agent_mcp_config.json mapping.

In this implementation, MCP servers are represented as lightweight
Python wrappers that call external tools (filesystem, postgres, etc.).
For production, replace with the official 'mcp' SDK client.
"""

from __future__ import annotations

import json
from pathlib import Path
from config import MCP_CONFIG_FILE


def _load_agent_config() -> dict:
    """Load the agent → allowed servers mapping."""
    if not MCP_CONFIG_FILE.exists():
        return {}
    with open(MCP_CONFIG_FILE, encoding="utf-8") as f:
        return json.load(f)


class MCPClient:
    """
    Minimal MCP client that wraps allowed tool servers for a specific agent.
    Agents call client.call(server, tool, **kwargs) to invoke an MCP tool.
    """

    def __init__(self, agent_name: str, allowed_servers: list[str]) -> None:
        self.agent_name = agent_name
        self.allowed_servers = allowed_servers

    def call(self, server: str, tool: str, **kwargs) -> dict:
        """
        Invoke a tool on a named MCP server.
        Raises PermissionError if the server is not allowed for this agent.
        """
        if server not in self.allowed_servers:
            raise PermissionError(
                f"Agent '{self.agent_name}' is not allowed to use MCP server '{server}'. "
                f"Allowed: {self.allowed_servers}"
            )

        # Route to the appropriate handler
        handler = _get_handler(server)
        return handler(tool, **kwargs)

    def list_allowed_servers(self) -> list[str]:
        return list(self.allowed_servers)

    def __repr__(self) -> str:
        return f"MCPClient(agent={self.agent_name}, servers={self.allowed_servers})"


def get_client(agent_name: str) -> MCPClient:
    """
    Factory function — returns an MCPClient configured for the given agent.
    If no config is found the client is returned with an empty server list.
    """
    config = _load_agent_config()
    servers: list[str] = config.get(agent_name, {}).get("servers", [])
    return MCPClient(agent_name=agent_name, allowed_servers=servers)


# ─── Server Handlers ──────────────────────────────────────────────────────────

def _get_handler(server: str):
    handlers = {
        "filesystem":     _handle_filesystem,
        "knowledge-base": _handle_knowledge_base,
        "postgres":       _handle_postgres,
        "github":         _handle_github,
        "sonarqube":      _handle_sonarqube,
        "swagger":        _handle_swagger,
        "shell":          _handle_shell,
    }
    if server not in handlers:
        raise ValueError(f"Unknown MCP server: '{server}'")
    return handlers[server]


def _handle_filesystem(tool: str, **kwargs) -> dict:
    from tools.file_tools import read_file, write_file, list_files, file_tree
    if tool == "read_file":
        return {"content": read_file(kwargs["path"])}
    if tool == "write_file":
        write_file(kwargs["path"], kwargs["content"])
        return {"success": True}
    if tool == "list_files":
        return {"files": list_files(kwargs["root"], kwargs.get("extensions"))}
    if tool == "file_tree":
        return {"tree": file_tree(kwargs["root"])}
    raise ValueError(f"Unknown filesystem tool: {tool}")


def _handle_knowledge_base(tool: str, **kwargs) -> dict:
    """
    Stub for vector DB knowledge base lookups.
    Replace with ChromaDB / Pinecone integration.
    """
    if tool == "query":
        return {"results": [], "note": "Knowledge base not configured. Returning empty."}
    raise ValueError(f"Unknown knowledge-base tool: {tool}")


def _handle_postgres(tool: str, **kwargs) -> dict:
    """Stub for Postgres MCP. Replace with real psycopg2 / asyncpg call."""
    if tool == "get_schema":
        return {"schema": {}, "note": "Postgres MCP not configured."}
    raise ValueError(f"Unknown postgres tool: {tool}")


def _handle_github(tool: str, **kwargs) -> dict:
    """Stub for GitHub MCP. Replace with PyGithub / GitHub API call."""
    if tool in ("create_pr", "commit"):
        return {"success": False, "note": "GitHub MCP not configured."}
    raise ValueError(f"Unknown github tool: {tool}")


def _handle_sonarqube(tool: str, **kwargs) -> dict:
    """Stub for SonarQube MCP. Replace with SonarQube API call."""
    if tool == "analyze":
        return {"issues": [], "note": "SonarQube MCP not configured."}
    raise ValueError(f"Unknown sonarqube tool: {tool}")


def _handle_swagger(tool: str, **kwargs) -> dict:
    """Stub for Swagger/OpenAPI MCP."""
    if tool == "validate":
        return {"valid": True, "note": "Swagger MCP not configured."}
    raise ValueError(f"Unknown swagger tool: {tool}")


def _handle_shell(tool: str, **kwargs) -> dict:
    from tools.shell_tools import run_command
    if tool == "run":
        return run_command(kwargs["cmd"], cwd=kwargs.get("cwd"))
    raise ValueError(f"Unknown shell tool: {tool}")
